<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Slide-sync ADMIN</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #1e293b; --card-bg: #2d384c; --primary-color: #fdbb2d; --secondary-text: #94a3b8; --text-color: #ffffff; --shadow: 0 10px 30px rgba(0, 0, 0, 0.5); --success-color: #10b981; --danger-color: #ef4444; }
        [data-theme="light"] { --bg-color: #f0f4f8; --card-bg: #ffffff; --primary-color: #1a2a6c; --secondary-text: #5f6368; --text-color: #202124; --shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg-color); color: var(--text-color); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; transition: background 0.3s; }
        .card { background: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow); padding: 40px; width: 100%; max-width: 1000px; margin: auto; border: 1px solid rgba(255, 255, 255, 0.05); }
        h1 { font-family: 'Playfair Display', serif; color: var(--primary-color); text-align: center; }
        h2 { color: var(--primary-color); border-bottom: 1px solid var(--secondary-text); padding-bottom: 10px; }
        #slideFrame { width: 100%; height: 500px; border: 1px solid rgba(255,255,255,0.1); background:#000; margin-bottom: 20px;}
        .controls { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 15px; }
        .control-row { display: flex; gap: 15px; margin-bottom: 25px; align-items: center; }
        button { background-color: var(--primary-color); color: #1e293b; border: none; border-radius: 8px; padding: 15px 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        button:hover { transform: translateY(-3px); opacity: 0.9; }
        .nav-btn { background-color: #334155; color: #fff; }
        .danger { background-color: var(--danger-color); color:white; }
        .success { background-color: var(--success-color); color:white; }
        select { padding: 15px; border-radius: 8px; background: #334155; color: white; border: 1px solid rgba(255,255,255,0.1); font-family: inherit; cursor: pointer; flex-grow: 1; }
        .tab { display: flex; justify-content: center; margin-bottom: 30px; border-bottom: 2px solid var(--secondary-text); }
        .tab button { background: transparent; color: var(--secondary-text); border-radius: 0; border-bottom: 3px solid transparent; box-shadow: none; }
        .tab button.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }
        ul { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
        li { padding: 10px; background: rgba(0,0,0,0.2); margin-bottom: 5px; border-radius: 5px; }
        textarea, input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--secondary-text); background: rgba(255,255,255,0.05); color: var(--text-color); margin-bottom: 10px; }
        
        /* MONITORING STYLES */
        .monitor-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .monitor-card { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .monitor-value { font-size: 2.5em; font-weight: bold; color: var(--primary-color); margin: 10px 0; }
        .monitor-label { font-size: 0.9em; color: var(--secondary-text); text-transform: uppercase; }
        .status-dot { height: 15px; width: 15px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background-color: var(--success-color); box-shadow: 0 0 10px var(--success-color); }
        .status-offline { background-color: var(--danger-color); }

        #loginScreen { text-align: center; }
        #loginBox { background: var(--card-bg); padding: 40px; border-radius: 16px; width: 350px; margin:auto; box-shadow: var(--shadow); }
        @media (max-width: 800px) { .controls { grid-template-columns: repeat(2, 1fr); } #slideFrame { height: 300px; } .monitor-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <button id="themeToggle" style="position:absolute; top:20px; right:20px; width:auto;">‚òÄÔ∏è Mode</button>

    <div id="loginScreen">
        <div id="loginBox">
            <h2>üîê Login Admin</h2>
            <input type="password" id="adminPass" placeholder="Password:..." />
            <button id="loginBtn">Masuk</button>
            <p id="loginError" style="color:red; display:none;">Password salah!</p>
        </div>
    </div>

    <div class="card" id="adminPanel" style="display:none;">
        <h1>Slide-sync ADMIN</h1>
        <div class="tab">
            <button id="tabKontrol" class="active">üéõÔ∏è Slide</button>
            <button id="tabPeserta">üë• Peserta</button>
            <button id="tabChat">üí¨ Chat</button>
            <button id="tabShare">üñ•Ô∏è Share</button>
            <button id="tabMonitor">üìä Monitor</button>
        </div>

        <div id="kontrolSection">
            <iframe id="slideFrame" src=""></iframe>
            <div class="control-row">
                <label for="transisiSelect">üé¨ Efek Transisi:</label>
                <select id="transisiSelect">
                    <option value="fade">‚ú® Fade (Standar)</option>
                    <option value="blur">üå´Ô∏è Blur</option>
                    <option value="flip">üîÑ Flip 3D</option>
                    <option value="circle">üîµ Circle Open</option>
                    <option value="book">üìñ Book Page</option>
                </select>
            </div>
            <div class="controls">
                <button id="prevBtn" class="nav-btn">‚¨ÖÔ∏è PREV</button>
                <button id="nextBtn" class="nav-btn">NEXT ‚û°Ô∏è</button>
                <button id="homeBtn">üè† HOME</button>
                <button id="restoreBtn" class="success">üîÅ RESTORE</button>
                <button id="blankBtn" class="danger">‚¨ú BLANK</button>
            </div>
            <p style="text-align:center">Slide Aktif: <b id="statusSlide">1</b></p>
        </div>

        <div id="pesertaSection" style="display:none;">
            <h2>üë• Peserta Online</h2><ul id="participantsList"></ul>
        </div>
        
        <div id="chatSection" style="display:none; display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div><h2>üì¢ Running Text</h2><textarea id="adminMessageInput" placeholder="Pesan info..."></textarea><button id="sendAdminMessageBtn" style="width:100%;">Kirim</button></div>
            <div><h2>üí¨ Pesan Masuk</h2><ul id="participantChatList"></ul></div>
            <button class="btn-danger" id="clearChatBtn" style="padding: 5px 12px; font-size: 0.8rem; margin: 0;">Bersihkan Chat</button>
        </div>
        
        <div id="shareScreenSection" style="display:none;">
            <h2>üñ•Ô∏è Share Screen</h2><input type="url" id="shareScreenLink" placeholder="Link..." /><div style="display:flex; gap:10px;"><button id="enableShareBtn" class="success" style="flex:1;">‚úÖ Aktifkan</button><button id="disableShareBtn" class="danger" style="flex:1;">‚ùå Matikan</button></div><p id="shareStatus" style="margin-top:10px;">Status: Nonaktif</p>
        </div>

        <!-- MONITORING SECTION -->
        <div id="monitorSection" style="display:none;">
            <h2>üìä Monitoring Server & Sistem</h2>
            <div class="monitor-grid">
                <div class="monitor-card">
                    <span id="serverStatusDot" class="status-dot"></span>
                    <span id="serverStatusText">Connecting...</span>
                    <div class="monitor-label">Status Server (Firebase)</div>
                </div>
                <div class="monitor-card">
                    <div id="latencyVal" class="monitor-value">0 ms</div>
                    <div class="monitor-label">Latency / Ping</div>
                </div>
                <div class="monitor-card">
                    <div id="activeUsersVal" class="monitor-value">0</div>
                    <div class="monitor-label">Total Peserta Aktif</div>
                </div>
                <div class="monitor-card">
                    <div id="memoryVal" class="monitor-value">-</div>
                    <div class="monitor-label">Penggunaan Memori (Admin)</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, push, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB0sPJBi9ITypeztIhtfXwTT5bSc5LbVI8",
            authDomain: "testslide1.firebaseapp.com",
            databaseURL: "https://testslide1-default-rtdb.firebaseio.com",
            projectId: "testslide1",
            storageBucket: "testslide1.firebasestorage.app",
            messagingSenderId: "405700914757",
            appId: "1:405700914757:web:250c2b1e8ca958ca68bd2c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const slideRef = ref(db, "slide");
        const participantsRef = ref(db, "participants");
        const adminChatRef = ref(db, "chat/adminMessage");
        const participantChatRef = ref(db, "chat/participantMessages");
        const shareScreenRef = ref(db, "shareScreen");
        const connectedRef = ref(db, ".info/connected");

        let currentSlide = 1; let lastNormalSlide = 1;
        const baseUrl = "https://docs.google.com/presentation/d/e/2PACX-1vRW29GKiX5OJ6paiSw2lD654cT2qPhSb-VFCfK9K-PAHwNvDDKP-2J2XHahTwr3_aXkjpR1Fa-4M4-h/pubembed?rm=minimal&start=false&loop=false&delayms=0&slide=";
        const iframe = document.getElementById("slideFrame");
        const transisiSelect = document.getElementById("transisiSelect");

        document.getElementById("loginBtn").onclick = () => { if(document.getElementById("adminPass").value === "admin123"){ document.getElementById("loginScreen").style.display = "none"; document.getElementById("adminPanel").style.display = "block"; updateSlide(); startMonitoring(); } else { document.getElementById("loginError").style.display = "block"; } };

        function updateSlide() { iframe.src = baseUrl + currentSlide; set(slideRef, { current: currentSlide, transition: transisiSelect.value }); document.getElementById("statusSlide").innerText = currentSlide; }
        document.getElementById("nextBtn").onclick = () => { lastNormalSlide=currentSlide; currentSlide++; updateSlide(); };
        document.getElementById("prevBtn").onclick = () => { lastNormalSlide=currentSlide; if(currentSlide>1) currentSlide--; updateSlide(); };
        document.getElementById("homeBtn").onclick = () => { lastNormalSlide=currentSlide; currentSlide=1; updateSlide(); };
        document.getElementById("blankBtn").onclick = () => { lastNormalSlide=currentSlide; currentSlide=7; updateSlide(); }; 
        document.getElementById("restoreBtn").onclick = () => { currentSlide=lastNormalSlide; updateSlide(); };
        transisiSelect.onchange = () => updateSlide();

        document.getElementById("sendAdminMessageBtn").onclick = () => { const msg = document.getElementById("adminMessageInput").value; if(msg) { push(adminChatRef, { message: msg, timestamp: Date.now() }); alert("Running text dikirim!"); document.getElementById("adminMessageInput").value = ""; } };
        onValue(participantChatRef, (s) => { const list = document.getElementById("participantChatList"); list.innerHTML = ""; const d = s.val(); if(d) { Object.values(d).forEach(m => { const li = document.createElement("li"); li.innerText = `${m.name}: ${m.message}`; list.appendChild(li); }); } });

        document.getElementById("enableShareBtn").onclick = () => { const url = document.getElementById("shareScreenLink").value; if(url) set(shareScreenRef, { active: true, link: url }); };
        document.getElementById("disableShareBtn").onclick = () => { const url = document.getElementById("shareScreenLink").value; set(shareScreenRef, { active: false, link: url }); };
        onValue(shareScreenRef, (s) => { const d = s.val(); document.getElementById("shareStatus").innerText = "Status: " + (d?.active ? "AKTIF" : "NONAKTIF"); });

        onValue(participantsRef, (s) => {
            const list = document.getElementById("participantsList"); list.innerHTML = ""; const d = s.val(); let count = 0;
            if(d) { Object.values(d).forEach(p => { if(Date.now() - p.lastSeen < 30000) { count++; const li = document.createElement("li"); li.innerHTML = `üü¢ <b>${p.name}</b>`; list.appendChild(li); } }); }
            document.getElementById("activeUsersVal").innerText = count;
        });

        // --- MONITORING LOGIC ---
        function startMonitoring() {
            // 1. Connection Status
            onValue(connectedRef, (snap) => {
                const connected = snap.val();
                const dot = document.getElementById("serverStatusDot");
                const txt = document.getElementById("serverStatusText");
                if (connected) { dot.classList.add("status-online"); dot.classList.remove("status-offline"); txt.innerText = "ONLINE (Terhubung)"; } 
                else { dot.classList.remove("status-online"); dot.classList.add("status-offline"); txt.innerText = "OFFLINE (Terputus)"; }
            });

            // 2. Latency Check (Ping)
            setInterval(() => {
                const start = Date.now();
                // Tulis dummy timestamp ke path khusus ping
                set(ref(db, "ping"), start).then(() => {
                    const latency = Date.now() - start;
                    const latEl = document.getElementById("latencyVal");
                    latEl.innerText = latency + " ms";
                    latEl.style.color = latency < 100 ? "var(--success-color)" : (latency < 300 ? "#fdbb2d" : "var(--danger-color)");
                });
            }, 2000);

            // 3. Memory (Chrome only)
            setInterval(() => {
                if (performance && performance.memory) {
                    const used = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                    const total = Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024);
                    document.getElementById("memoryVal").innerText = `${used} MB / ${total} MB`;
                } else {
                    document.getElementById("memoryVal").innerText = "Tidak Didukung Browser";
                }
            }, 3000);
        }

        // -- CLEAR ALL CHAT --
        document.getElementById("clearChatBtn").onclick = () => {
            if(confirm("Apakah Anda yakin ingin MENGHAPUS SEMUA CHAT dari peserta? Tindakan ini tidak dapat dibatalkan.")) {
            set(participantChatRef, null)
                .then(() => alert("Semua chat telah dibersihkan."))
                .catch((err) => console.error("Gagal menghapus chat:", err));
                }
            };

        const tabs = { tabKontrol: "kontrolSection", tabPeserta: "pesertaSection", tabChat: "chatSection", tabShare: "shareScreenSection", tabMonitor: "monitorSection" };
        Object.keys(tabs).forEach(id => {
            document.getElementById(id).onclick = function() {
                document.querySelectorAll(".tab button").forEach(b => b.classList.remove("active")); this.classList.add("active");
                Object.values(tabs).forEach(sec => document.getElementById(sec).style.display = "none");
                document.getElementById(tabs[id]).style.display = (id === 'chatSection' || id === 'monitorSection') ? 'grid' : 'block';
                if(id === 'monitorSection') document.querySelector('#monitorSection .monitor-grid').style.display = 'grid'; // Fix grid display reset
            }
        });
        document.getElementById("themeToggle").onclick = () => { const html = document.documentElement; html.setAttribute('data-theme', html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); };
    </script>
</body>
</html>